---
# Ansible task file for yabai window manager setup

- name: Check if yabai is installed
  command: which yabai
  register: yabai_check
  ignore_errors: yes
  changed_when: false

- name: Check if skhd is installed
  command: which skhd
  register: skhd_check
  ignore_errors: yes
  changed_when: false

- name: Ensure yabai and skhd are installed
  debug:
    msg: "yabai and skhd should be installed via the packages.yml task"
  when: yabai_check.rc != 0 or skhd_check.rc != 0

- name: Create yabai config directory
  file:
    path: "{{ ansible_env.HOME }}/.config/yabai"
    state: directory
    mode: '0755'

- name: Create skhd config directory
  file:
    path: "{{ ansible_env.HOME }}/.config/skhd"
    state: directory
    mode: '0755'

- name: Deploy yabai configuration
  template:
    src: ../templates/yabairc.j2
    dest: "{{ ansible_env.HOME }}/.yabairc"
    mode: '0755'
    backup: yes
  tags: [yabai-config]

- name: Deploy skhd configuration
  template:
    src: ../templates/skhdrc.j2
    dest: "{{ ansible_env.HOME }}/.skhdrc"
    mode: '0644'
    backup: yes
  tags: [skhd-config]

- name: Check yabai service status
  command: yabai --check-sa
  register: yabai_sa_status
  ignore_errors: yes
  changed_when: false

- name: Display yabai SIP requirements
  debug:
    msg: |
      ============================================================
      YABAI SETUP REQUIREMENTS
      ============================================================
      
      Yabai has been installed but requires additional setup:
      
      1. GRANT ACCESSIBILITY PERMISSIONS (REQUIRED):
         System Settings > Privacy & Security > Accessibility
         - Click the lock to make changes
         - Click '+' and add: /opt/homebrew/bin/yabai
         - Click '+' and add: /opt/homebrew/bin/skhd
         - Ensure both toggles are ENABLED
      
      2. START SERVICES:
         Run these commands to start the services:
         yabai --start-service
         skhd --start-service
      
      3. OPTIONAL - DISABLE SIP (for advanced features):
         Some features require partially disabling SIP:
         - Window borders
         - Focus follows mouse
         - Window opacity
         
         To disable SIP partially:
         a) Restart in Recovery Mode (Intel: Cmd+R, Apple Silicon: hold power)
         b) Open Terminal and run:
            csrutil enable --without fs --without debug --without nvram
         c) Restart
      
      4. RELOAD CONFIGURATION:
         After making changes to config files:
         yabai --restart-service
         skhd --restart-service
      
      ============================================================
    verbosity: 0

- name: Create yabai log directory
  file:
    path: "{{ ansible_env.HOME }}/.local/share/yabai"
    state: directory
    mode: '0755'

- name: Create skhd log directory
  file:
    path: "{{ ansible_env.HOME }}/.local/share/skhd"
    state: directory
    mode: '0755'