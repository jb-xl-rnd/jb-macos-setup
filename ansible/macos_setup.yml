---
- name: Setup MacOS Development Environment
  hosts: localhost
  become: false
  vars_files:
    - "../config/packages.json"
    - "../config/config.json"
    - "../config/shell_config.json"
    
  vars:
    python_version: "3.11.8"  # Specify the Python version you want to use
    use_uv: "{{ feature_flags.use_uv_package_manager | default(false) }}"
    use_pyenv: "{{ feature_flags.use_pyenv | default(false) }}"
    use_custom_prompt: "{{ feature_flags.custom_shell_prompt | default(false) }}"
    use_alias_compat: "{{ feature_flags.alias_compatibility | default(false) }}"
    install_dutis: "{{ feature_flags.install_dutis | default(true) }}"
    dutis_auto_configure: "{{ feature_flags.dutis_auto_configure | default(true) }}"

  pre_tasks:
    - name: Install required Ansible collections
      ansible.builtin.command:
        cmd: ansible-galaxy collection install community.general
      delegate_to: localhost
      run_once: true
      
    - name: Display important setup notice
      debug:
        msg: |
          ==========================================================
          IMPORTANT SETUP NOTICE
          ==========================================================
          
          This playbook will install and configure various tools for
          your macOS system. Some operations may require sudo access.
          
          We've designed the setup to use user-level permissions
          whenever possible, but some operations might still require
          administrative privileges.
          
          Note that dutis will be installed to ~/.local/bin to avoid
          sudo requirements. For automatic file association setup,
          you may need to run the script manually later.
          ==========================================================
        verbosity: 1
  
  tasks:
    # Include package installation tasks
    - name: Install Homebrew packages and applications
      include_tasks: tasks/packages.yml
      tags: [packages, brew, apps]
      
    # Include Python environment setup
    - name: Configure Python environment
      include_tasks: tasks/python_env.yml
      tags: [python, pyenv, uv]
      
    # Include shell configuration
    - name: Configure shell environment
      include_tasks: tasks/shell_config.yml
      tags: [shell, zsh]
      
    # Include dutis installation and configuration
    - name: Install and configure dutis
      include_tasks: tasks/dutis.yml
      tags: [dutis, defaults]
      
    # Include LazyVim installation
    - name: Setup LazyVim
      include_tasks: tasks/lazyvim.yml
      tags: [lazyvim, neovim, editor]
      
    # Include Kitty terminal configuration
    - name: Configure Kitty terminal
      include_tasks: tasks/kitty.yml
      tags: [kitty, terminal]